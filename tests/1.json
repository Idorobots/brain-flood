{
    "server" : {
    	"host" : "localhost",
	"port" : 8080,
	"endpoint" : "/socket.io/1/",
	"metadata" : {
	    "ping_timeout" : 5000
	}
    },
    
    "phases" : [
    	{
	    "name" : "Sample Phase I",
	    "users" : 10,
	    "start_time" : 1000,
	    "duration" : 1000,
	    "user_sessions" : ["Sample WebSocket Session", "Sample XHR-polling Session"],
	    "metadata" : {
	    	"session_timeout" : 60000
	    }
	},
	{
	    "name" : "Sample Phase II",
	    "users" : 100,
	    "start_time" : 5000,
	    "duration" : 5000,
	    "user_sessions" : ["Sample WebSocket Session", "Sample XHR-polling Session"],
	    "metadata" : {
	    	"session_timeout" : 30000
	    }
	}
    ],
    
    "sessions" : [
	{
	    "name" : "Sample WebSocket Session",
	    "transport" : "websocket",
	    "weight" : 0.8,
	    "metadata" : {
		"event" : "ping",
		"args" : "WebSocket"
	    },

	    "do" : [
		["start_timer", {"name" : "session_timeout", "time" : "$session_timeout"}],
		["on_timeout", {"name" : "session_timeout", "do" : [
		    ["log", {"format" : "Session timed out. Closing connection: ~s.",
			     "values" : ["$server.sid"]}],
		    ["terminate", {"reason" : "Session timed out."}]
		]}],

		["on_socketio", {"opcode" : "1", "do" : [
		    ["log", {"format" : "Connected!"}],
		    
		    ["start_timer", {"name" : "hb_timeout", "time" : "$server.heartbeat_timeout"}],
		    ["on_socketio", {"opcode" : "8", "do" : [
			["restart_timer", {"name" : "hb_timeout", "time" : "$server.heartbeat_timeout"}]
		    ]}],
		    ["on_socketio", {"opcode" : "5", "do" : [
		    	["restart_timer", {"name" : "hb_timeout", "time" : "$server.heartbeat_timeout"}]
		    ]}],
		    ["on_timeout", {"name" : "hb_timeout", "do" : [
			["terminate", {"reason" : "Didn't receive a heartbeat on time!"}]
		    ]}],

		    ["on_event", {"name" : "comet_error", "do" : [
			["match", {"re" : "{\"error\":\"(.*)\",\"description\":(.*)}",
				   "subject" : "$event.args",
				   "on_match" : [
				       ["log", {"format" : "Received a Comet error message ~s: ~s!",
						"values" : ["$match_0", "$match_1"]}]
				   ]}]
		    ]}],

		    ["start_timer", {"name" : "ping_timeout", "time" : "$ping_timeout"}],
		    ["on_timeout", {"name" : "ping_timeout", "do" : [
			["log", {"format" : "Pinging!"}],
			["emit_event", {"name" : "$event", "args" : "$args"}]
		    ]}],
		    ["on_event", {"name" : "ping", "do" : [
			["log", {"format" : "Got pong!"}],
			["restart_timer", {"name" : "ping_timeout", "time" : "$ping_timeout"}]
		    ]}]
		]}],

		["on_socketio", {"opcode" : "0", "do" : [
		    ["log", {"format" : "Disconnected!"}],
		    ["terminate", {"reason" : "shutdown"}]
		]}]
	    ]
	},
	{
	    "name" : "Sample XHR-polling Session",
	    "transport" : "xhr_polling",
	    "weight" : 0.2,
	    "metadata" : {
		"event" : "ping",
		"args" : "XHR-polling"
	    },

	    "do" : [
		["start_timer", {"name" : "session_timeout", "time" : "$session_timeout"}],
		["on_timeout", {"name" : "session_timeout", "do" : [
		    ["log", {"format" : "Session timed out. Closing connection: ~s.",
			     "values" : ["$server.sid"]}],
		    ["terminate", {"reason" : "Session timed out."}]
		]}],

		["on_socketio", {"opcode" : "1", "do" : [
		    ["log", {"format" : "Connected!"}],
		    
		    ["start_timer", {"name" : "hb_timeout", "time" : "$server.heartbeat_timeout"}],
		    ["on_socketio", {"opcode" : "8", "do" : [
			["restart_timer", {"name" : "hb_timeout", "time" : "$server.heartbeat_timeout"}]
		    ]}],
		    ["on_socketio", {"opcode" : "5", "do" : [
		    	["restart_timer", {"name" : "hb_timeout", "time" : "$server.heartbeat_timeout"}]
		    ]}],
		    ["on_timeout", {"name" : "hb_timeout", "do" : [
			["terminate", {"reason" : "Didn't receive a heartbeat on time!"}]
		    ]}],

		    ["on_event", {"name" : "comet_error", "do" : [
			["match", {"re" : "{\"error\":\"(.*)\",\"description\":(.*)}", 
				   "subject" : "$event.args", 
				   "on_match" : [
				       ["log", {"format" : "Received a Comet error message ~s: ~s!", 
						"values" : ["$match_0", "$match_1"]}]
				   ]}]
		    ]}],

		    ["start_timer", {"name" : "ping_timeout", "time" : "$ping_timeout"}],
		    ["on_timeout", {"name" : "ping_timeout", "do" : [
			["log", {"format" : "Pinging!"}],
			["emit_event", {"name" : "$event", "args" : "$args"}]
		    ]}],
		    ["on_event", {"name" : "ping", "do" : [
			["log", {"format" : "Got pong!"}],
			["restart_timer", {"name" : "ping_timeout", "time" : "$ping_timeout"}]
		    ]}]
		]}],

		["on_socketio", {"opcode" : "0", "do" : [
		    ["log", {"format" : "Disconnected!"}],
		    ["terminate", {"reason" : "shutdown"}]
		]}]
	    ]
	}
    ]
}
